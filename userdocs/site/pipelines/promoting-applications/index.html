<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="The Flux expansion pack from the founders of Flux" name=description><meta content="Weave GitOps authors" name=author><link href=https://docs.gitops.weave.works/pipelines/promoting-applications/ rel=canonical><link href=../authorization/ rel=prev><link href=../pipelines-templates/ rel=next><link href=../../img/favicon_150px.png rel=icon><meta content="mkdocs-1.4.2, mkdocs-material-9.0.6" name=generator><title>Promoting applications - Weave GitOps</title><link href=../../assets/stylesheets/main.558e4712.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.2505c338.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Segoe+UI:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Segoe UI";--md-code-font:"Roboto Mono"}</style><link href=../../stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script><meta content=website property=og:type><meta content="Promoting applications - Weave GitOps" property=og:title><meta content="The Flux expansion pack from the founders of Flux" property=og:description><meta content=https://docs.gitops.weave.works/assets/images/social/pipelines/promoting-applications.png property=og:image><meta content=image/png property=og:image:type><meta content=1200 property=og:image:width><meta content=630 property=og:image:height><meta content=https://docs.gitops.weave.works/pipelines/promoting-applications/ property=og:url><meta content=summary_large_image name=twitter:card><meta content="Promoting applications - Weave GitOps" name=twitter:title><meta content="The Flux expansion pack from the founders of Flux" name=twitter:description><meta content=https://docs.gitops.weave.works/assets/images/social/pipelines/promoting-applications.png name=twitter:image><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent=light-blue data-md-color-primary=deep-orange data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#promoting-applications-through-pipeline-environments> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Weave GitOps" class="md-header__button md-logo" data-md-component=logo href=../.. title="Weave GitOps"> <img alt=logo src=../../img/logo.ico> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Weave GitOps </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Promoting applications </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent=light-blue data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary=deep-orange data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent=light-blue data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary=deep-orange data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <a aria-label=Share class="md-search__icon md-icon" data-clipboard data-clipboard-text data-md-component=search-share href=javascript:void(0) tabindex=-1 title=Share> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"></path></svg> </a> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/weaveworks/weave-gitops title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> weaveworks/weave-gitops </div> </a> </div> </nav> <nav aria-label=Tabs class=md-tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a class=md-tabs__link href=../..> Home </a> </li> <li class=md-tabs__item> <a href=../../intro-weave-gitops/ class="md-tabs__link md-tabs__link--active"> Docs </a> </li> <li class=md-tabs__item> <a href=../../references/helm-reference/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../security/ class=md-tabs__link> Security </a> </li> <li class=md-tabs__item> <a href=../../feedback-and-telemetry/ class=md-tabs__link> Feedback &amp; Telemetry </a> </li> <li class=md-tabs__item> <a href=../../help-and-support/ class=md-tabs__link> Support </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary md-nav--lifted" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Weave GitOps" class="md-nav__button md-logo" data-md-component=logo href=../.. title="Weave GitOps"> <img alt=logo src=../../img/logo.ico> </a> Weave GitOps </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/weaveworks/weave-gitops title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> weaveworks/weave-gitops </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label aria-expanded=true class=md-nav__link for=__nav_2 tabindex=0> Docs <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Docs class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Docs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 id=__nav_2_1 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1 tabindex=0> Introducing Weave GitOps <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Introducing Weave GitOps" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Introducing Weave GitOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../intro-weave-gitops/ class=md-nav__link> Introducing Weave GitOps </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_2 id=__nav_2_1_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1_2 tabindex=0> Weave GitOps OSS <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Weave GitOps OSS" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> Weave GitOps OSS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../open-source/install-oss/ class=md-nav__link> Step 1 - Install Weave GitOps Open Source </a> </li> <li class=md-nav__item> <a href=../../open-source/ui-oss/ class=md-nav__link> Step 2 - Explore the Open Source UI </a> </li> <li class=md-nav__item> <a href=../../open-source/deploy-oss/ class=md-nav__link> Step 3 - Deploy an Application </a> </li> <li class=md-nav__item> <a href=../../open-source/aws-marketplace/ class=md-nav__link> AWS Marketplace </a> </li> <li class=md-nav__item> <a href=../../open-source/run-ui-subpath/ class=md-nav__link> Optional: Running the UI on a Subpath </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_3 id=__nav_2_1_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1_3 tabindex=0> Weave GitOps Enterprise <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Weave GitOps Enterprise" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_1_3> <span class="md-nav__icon md-icon"></span> Weave GitOps Enterprise </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../enterprise/ class=md-nav__link> Introduction to Weave GitOps Enterprise </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise/ class=md-nav__link> Install Weave GitOps Enterprise </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-cli/ class=md-nav__link> Install Weave GitOps Enterprise via CLI </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-airgap/ class=md-nav__link> Install Enterprise in Air-gapped Environments </a> </li> <li class=md-nav__item> <a href=../../enterprise/releases-enterprise/ class=md-nav__link> Enterprise Releases </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-azure/ class=md-nav__link> Azure and Weave GitOps Enterprise Installation </a> </li> <li class=md-nav__item> <a href=../../enterprise/join-cluster-azure-flux/ class=md-nav__link> Join a Cluster with Azure Flux </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../backstage/ class=md-nav__link> Backstage </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 id=__nav_2_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_3 tabindex=0> Cluster Management <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Cluster Management" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Cluster Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cluster-management/ class=md-nav__link> Cluster Management - Introduction </a> </li> <li class=md-nav__item> <a href=../../cluster-management/managing-clusters-without-capi/ class=md-nav__link> Managing Clusters Without Cluster API </a> </li> <li class=md-nav__item> <a href=../../cluster-management/deploying-capa-eks/ class=md-nav__link> Deploying CAPA with EKS </a> </li> <li class=md-nav__item> <a href=../../cluster-management/profiles/ class=md-nav__link> Profiles </a> </li> <li class=md-nav__item> <a href=../../cluster-management/cluster-management-troubleshooting/ class=md-nav__link> Cluster Management Troubleshooting </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3_6 id=__nav_2_3_6 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_3_6 tabindex=0> Advanced Cluster management <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Advanced Cluster management" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_3_6> <span class="md-nav__icon md-icon"></span> Advanced Cluster management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cluster-management/advanced-cluster-management-topics/how-to-inject-credentials-into-template/ class=md-nav__link> How to Inject Credentials Into Your Template </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 id=__nav_2_4 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_4 tabindex=0> Explorer <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Explorer class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Explorer </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../explorer/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../explorer/getting-started/ class=md-nav__link> Getting started </a> </li> <li class=md-nav__item> <a href=../../explorer/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../explorer/querying/ class=md-nav__link> Querying </a> </li> <li class=md-nav__item> <a href=../../explorer/operations/ class=md-nav__link> Operations </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_5 id=__nav_2_5 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_5 tabindex=0> GitOpsSets <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=GitOpsSets class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> GitOpsSets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitopssets/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-installation/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../gitopssets/templating-from-generators/ class=md-nav__link> Templating from Generators </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-api-reference/ class=md-nav__link> API reference </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-releases/ class=md-nav__link> Releases </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_6 id=__nav_2_6 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_6 tabindex=0> Guides <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Guides class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/displaying-custom-metadata/ class=md-nav__link> Displaying Custom Metadata </a> </li> <li class=md-nav__item> <a href=../../guides/fluxga-upgrade/ class=md-nav__link> Upgrade to Flux GA </a> </li> <li class=md-nav__item> <a href=../../guides/anonymous-access/ class=md-nav__link> Anonymous Access </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../monitoring/ class=md-nav__link> Operations </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_8 id=__nav_2_8 type=checkbox> <label aria-expanded=true class=md-nav__link for=__nav_2_8 tabindex=0> Pipelines <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Pipelines class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../pipelines-getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../authorization/ class=md-nav__link> Authorization </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Promoting applications <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Promoting applications </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#expose-the-promotion-webhook> Expose the promotion webhook </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setup-notifications-from-leaf-clusters> Setup notifications from leaf clusters </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pull-request> Pull request </a> <nav aria-label="Pull request" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#security> Security </a> <nav aria-label=Security class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#environments-and-repositories> Environments and Repositories </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rbac> RBAC </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#policy> Policy </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#service-account> Service Account </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#verify-security-context> Verify Security Context </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#tokens> Tokens </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#add-markers-to-app-manifests> Add markers to app manifests </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#supported-git-providers> Supported Git Providers </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#credentials-secret> Credentials Secret </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#define-promotion-in-pipeline-resource> Define promotion in pipeline resource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#notification> Notification </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#manual-promotion> Manual promotion </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuration> Configuration </a> <nav aria-label=Configuration class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#retry-logic> Retry Logic </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rate-limiting> Rate Limiting </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../pipelines-templates/ class=md-nav__link> Using GitOpsTemplates for Pipelines </a> </li> <li class=md-nav__item> <a href=../pipelines-with-jenkins/ class=md-nav__link> Pipelines With Jenkins Webhook </a> </li> <li class=md-nav__item> <a href=../pipelines-with-tekton/ class=md-nav__link> Pipelines With Tekton </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_8_8 id=__nav_2_8_8 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_8_8 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_8_8> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../spec/v1alpha1/pipeline/ class=md-nav__link> v1alpha1 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_9 id=__nav_2_9 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_9 tabindex=0> Policy <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Policy class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> Policy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../policy/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../policy/getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../policy/authorization/ class=md-nav__link> Authorization </a> </li> <li class=md-nav__item> <a href=../../policy/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../policy/weave-policy-profile/ class=md-nav__link> Policy Profile </a> </li> <li class=md-nav__item> <a href=../../policy/policy-set/ class=md-nav__link> PolicySet </a> </li> <li class=md-nav__item> <a href=../../policy/policy-configuration/ class=md-nav__link> PolicyConfig </a> </li> <li class=md-nav__item> <a href=../../policy/releases/ class=md-nav__link> Profile Releases </a> </li> <li class=md-nav__item> <a href=../../policy/commit-time-checks/ class=md-nav__link> Commit/Build Time Checks </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_10 id=__nav_2_10 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_10 tabindex=0> Progressive Delivery <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Progressive Delivery" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> Progressive Delivery </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../progressive-delivery/progressive-delivery-flagger-install/ class=md-nav__link> Progressive Delivery Using Flagger </a> </li> <li class=md-nav__item> <a href=../../progressive-delivery/flagger-manual-gating/ class=md-nav__link> Manual Approval for Progressive Delivery Deployments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_11 id=__nav_2_11 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_11 tabindex=0> Secrets <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Secrets class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_11> <span class="md-nav__icon md-icon"></span> Secrets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../secrets/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../secrets/getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../secrets/bootstrapping-secrets/ class=md-nav__link> Bootstrapping Secrets </a> </li> <li class=md-nav__item> <a href=../../secrets/setup-eso/ class=md-nav__link> Setup ESO </a> </li> <li class=md-nav__item> <a href=../../secrets/setup-sops/ class=md-nav__link> Setup SOPS </a> </li> <li class=md-nav__item> <a href=../../secrets/manage-secrets-ui/ class=md-nav__link> Manage Secrets UI </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_11_7 id=__nav_2_11_7 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_11_7 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_11_7> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../secrets/spec/v1alpha1/secretSync/ class=md-nav__link> v1alpha1 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_12 id=__nav_2_12 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_12 tabindex=0> Templates <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Templates class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_12> <span class="md-nav__icon md-icon"></span> Templates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitops-templates/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_12_2 id=__nav_2_12_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_12_2 tabindex=0> Creating Templates <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Creating Templates" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_12_2> <span class="md-nav__icon md-icon"></span> Creating Templates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitops-templates/creating-templates/ class=md-nav__link> Creating Templates </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/resource-templates/ class=md-nav__link> Resource Templates </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/repo-rendered-paths/ class=md-nav__link> Rendered Template Paths </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/profiles/ class=md-nav__link> Profiles </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/annotations/ class=md-nav__link> Annotations </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/params/ class=md-nav__link> Parameters </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/supported-langs/ class=md-nav__link> Supported Templating Languages </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/create-cluster-example/ class=md-nav__link> Example: Template to Create a CAPI Cluster </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/quickstart-templates/ class=md-nav__link> Quickstart </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../gitops-templates/cli/ class=md-nav__link> CLI </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/versions/ class=md-nav__link> Version Information </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_13 id=__nav_2_13 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_13 tabindex=0> Terraform <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Terraform class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_13> <span class="md-nav__icon md-icon"></span> Terraform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Introduction to Terraform Controller </a> </li> <li class=md-nav__item> <a href=../../terraform/get-started-terraform/ class=md-nav__link> Get Started </a> </li> <li class=md-nav__item> <a href=../../terraform/using-terraform-templates/ class=md-nav__link> Using Terraform Templates </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_14 id=__nav_2_14 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_14 tabindex=0> Workspaces <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Workspaces class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_14> <span class="md-nav__icon md-icon"></span> Workspaces </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../workspaces/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../workspaces/multi-tenancy/ class=md-nav__link> Multi Tenancy </a> </li> <li class=md-nav__item> <a href=../../workspaces/view-workspaces/ class=md-nav__link> Workspaces View </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_3 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../references/helm-reference/ class=md-nav__link> OSS Helm Reference </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 id=__nav_3_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_3_2 tabindex=0> CLI Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="CLI Reference" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> CLI Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../references/cli-reference/gitops/ class=md-nav__link> Gitops </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_check/ class=md-nav__link> Gitops check </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion/ class=md-nav__link> Gitops completion </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_bash/ class=md-nav__link> Gitops completion bash </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_fish/ class=md-nav__link> Gitops completion fish </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_powershell/ class=md-nav__link> Gitops completion powershell </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_zsh/ class=md-nav__link> Gitops completion zsh </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create/ class=md-nav__link> Gitops create </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create_dashboard/ class=md-nav__link> Gitops create dashboard </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create_terraform/ class=md-nav__link> Gitops create terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_delete/ class=md-nav__link> Gitops delete </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_delete_terraform/ class=md-nav__link> Gitops delete terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get/ class=md-nav__link> Gitops get </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get_bcrypt-hash/ class=md-nav__link> Gitops get bcrypt hash </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get_config/ class=md-nav__link> Gitops get config </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_logs/ class=md-nav__link> Gitops logs </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_logs_terraform/ class=md-nav__link> Gitops logs terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_replan/ class=md-nav__link> Gitops replan </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_replan_terraform/ class=md-nav__link> Gitops replan terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_resume/ class=md-nav__link> Gitops resume </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_resume_terraform/ class=md-nav__link> Gitops resume terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_set/ class=md-nav__link> Gitops set </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_set_config/ class=md-nav__link> Gitops set config </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_suspend/ class=md-nav__link> Gitops suspend </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_suspend_terraform/ class=md-nav__link> Gitops suspend terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_version/ class=md-nav__link> Gitops version </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../security/ class=md-nav__link> Security </a> </li> <li class=md-nav__item> <a href=../../feedback-and-telemetry/ class=md-nav__link> Feedback &amp; Telemetry </a> </li> <li class=md-nav__item> <a href=../../help-and-support/ class=md-nav__link> Support </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#expose-the-promotion-webhook> Expose the promotion webhook </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setup-notifications-from-leaf-clusters> Setup notifications from leaf clusters </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pull-request> Pull request </a> <nav aria-label="Pull request" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#security> Security </a> <nav aria-label=Security class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#environments-and-repositories> Environments and Repositories </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rbac> RBAC </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#policy> Policy </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#service-account> Service Account </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#verify-security-context> Verify Security Context </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#tokens> Tokens </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#add-markers-to-app-manifests> Add markers to app manifests </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#supported-git-providers> Supported Git Providers </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#credentials-secret> Credentials Secret </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#define-promotion-in-pipeline-resource> Define promotion in pipeline resource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#notification> Notification </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#manual-promotion> Manual promotion </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#configuration> Configuration </a> <nav aria-label=Configuration class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#retry-logic> Retry Logic </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#rate-limiting> Rate Limiting </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=promoting-applications-through-pipeline-environments>Promoting applications through pipeline environments<a class=headerlink href=#promoting-applications-through-pipeline-environments title="Permanent link">¶</a></h1> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p><strong>This feature is in alpha and certain aspects will change</strong> We're very excited for people to use this feature. However, please note that changes in the API, behaviour and security will evolve. The feature is suitable to use in controlled testing environments.</p> </div> <p>Pipelines allow you to configure automatic promotions of applications through a consecutive set of environments, e.g. from dev to staging to production. The environments are defined in the <code>Pipeline</code> resource itself so that each pipeline governs a single application and all the environments to which it is deployed.</p> <div class="admonition info"> <p class=admonition-title>Info</p> <p>At the moment only applications defined as Flux <code>HelmReleases</code> are supported in automatic promotions.</p> </div> <figure> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/promotion-pr.png><img alt="an example promotion PR" src=/img/promotion-pr.png></a> </p> <figcaption>An example of a pull request for an application promotion</figcaption> </figure> <p>The <a href=../pipelines-getting-started/ >Getting Started Guide</a> describes how to create a basic pipeline for an application so you can visualize its deployments across a series of environments. You may also configure a pipeline in order to promote applications across a series of environments. There are currently two supported strategies for application promotions:</p> <ul> <li>Pull request strategy: this strategy is used for applications that are delivered via Flux to all environments of a pipeline. Typically, the versions of these applications are stored in Git and therefore pull requests can be used to update them as part of a promotion.</li> <li>Notification strategy: this strategy is used when an external CI system is responsible for promoting an application across the environments of a pipeline. In this strategy, the notification controller running on the management cluster is used to forward notifications of successful promotions to external CI systems.</li> </ul> <p>Before configuring any of the above promotion strategies, you need to setup notifications from all your environments so that whenever a new version gets deployed, the promotion webhook component of the pipeline controller is notified and takes an action based on the pipeline definition. The rest of this guide describes the configuration needed to setup application promotion via pipelines.</p> <h2 id=expose-the-promotion-webhook>Expose the promotion webhook<a class=headerlink href=#expose-the-promotion-webhook title="Permanent link">¶</a></h2> <p>Applications deployed in leaf clusters use the Flux notification controller running on each leaf cluster, to notify the management cluster of a successful promotion. This requires network connectivity to be established between the leaf cluster and the management cluster.</p> <p>The component responsible for listening to incoming notifications from leaf clusters is the pipeline controller. It hosts a webhook service that needs to be exposed via an ingress resource to make it available for external calls. Exposing the webhook service is done via the Weave GitOps Enterprise Helm chart values and the configuration used depends on your environment. The example below shows the configuration for NGINX ingress controller and needs to be adjusted if another ingress controller is used:</p> <div class=highlight><pre><span></span><code><span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>values</span><span class=p>:</span>
<span class=w>    </span><span class=nt>enablePipelines</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>    </span><span class=nt>pipeline-controller</span><span class=p>:</span>
<span class=w>      </span><span class=nt>promotion</span><span class=p>:</span>
<span class=w>        </span><span class=nt>ingress</span><span class=p>:</span>
<span class=w>          </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>          </span><span class=nt>className</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class=w>          </span><span class=nt>annotations</span><span class=p>:</span>
<span class=w>            </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt</span>
<span class=w>          </span><span class=nt>hosts</span><span class=p>:</span>
<span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotions.example.org</span>
<span class=w>            </span><span class=nt>paths</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/?(.*)</span>
<span class=w>              </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<span class=w>          </span><span class=nt>tls</span><span class=p>:</span>
<span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotions-tls</span>
<span class=w>            </span><span class=nt>hosts</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotions.example.org</span>
</code></pre></div> <p>You will need the externally reachable URL of this service later on in this guide.</p> <h2 id=setup-notifications-from-leaf-clusters>Setup notifications from leaf clusters<a class=headerlink href=#setup-notifications-from-leaf-clusters title="Permanent link">¶</a></h2> <p>Once the webhook service is exposed over HTTP/S, you need to create alert/provider resources to send notifications to it from leaf clusters. These notifications represent successful promotions for applications running on the leaf clusters.</p> <p>Successful promotion events are triggered by Flux's <a href=https://fluxcd.io/flux/components/notification/ >notification controller</a>. You create a Provider pointing to the promotion webhook exposed earlier and an Alert targeting the app's HelmRelease:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">notification.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Provider</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-my-app</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=s>"https://promotions.example.org/promotion/pipeline-01/my-app/dev"</span>
<span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">generic-hmac</span>
<span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">hmac-secret</span>
</code></pre></div> <p>In the example above, the <code>generic-hmac</code> Provider is used to ensure notifications originate from authenticated sources. The referenced Secret, should include a <code>token</code> field which holds the HMAC key. The same HMAC key must be specified in the Secret referenced by the <code>.spec.promotion.strategy.secretRef.name</code> field, so that the pipeline controller can verify any incoming notifications. For more information on the <code>generic-hmac</code> Provider, please refer to the notification controller <a href=https://fluxcd.io/flux/components/notification/provider/#generic-webhook-with-hmac>docs</a>.</p> <p>Note that by default, the promotion webhook endpoint is exposed at <code>/promotion</code> as shown in the example above. However you may use rewrite rules in your ingress configuration to omit it, if desired. For example, if using NGINX ingress controller, you may use the following annotation: <div class=highlight><pre><span></span><code><span class=nt>annotations</span><span class=p>:</span>
<span class=w>  </span><span class=nt>nginx.ingress.kubernetes.io/rewrite-target</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/promotion/$1</span>
</code></pre></div> The Provider address can then be set as <code>https://promotions.example.org/pipeline-01/my-app/dev</code>.</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>You may also use the <a href=https://fluxcd.io/flux/components/notification/provider/#generic-webhook-with-hmac>generic webhook provider type that supports HMAC verification</a> to ensure incoming notifications originate from authenticated sources.</p> </div> <p>The <code>address</code> field's URL path is comprised of 3 components again:</p> <ol> <li>The namespace of the app's pipeline.</li> <li>The name of the pipeline resource.</li> <li>The origin environment's name. This is the name of the environment that the event is created in, e.g. "dev" for events coming from the "dev" environment.</li> </ol> <p>Weave GitOps Enterprise can then parse the incoming URL path to identify the pipeline resource and look up the next environment for the defined promotion action.</p> <p>An example Alert might look like this:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">notification.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Alert</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>eventSeverity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">info</span>
<span class=w>  </span><span class=nt>eventSources</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class=w>  </span><span class=nt>exclusionList</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.*upgrade.*has.*started</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">.*is.*not.*ready</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">^Dependencies.*</span>
<span class=w>  </span><span class=nt>providerRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-my-app</span>
</code></pre></div> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Be sure to create the Provider/Alert tuple on <strong>each of the leaf clusters targeted by a pipeline</strong>.</p> </div> <p>Now as soon as the <code>HelmRelease</code> on the first environment defined in the pipeline is bumped (e.g. by Flux discovering a new version in the Helm repository), an event is sent to the promotion webhook which will determine the next action based on the pipeline definition and chosen strategy. The rest of this guide describes how to setup up any of the available strategies depending on your requirements.</p> <h2 id=pull-request>Pull request<a class=headerlink href=#pull-request title="Permanent link">¶</a></h2> <div class="admonition danger"> <p class=admonition-title>Danger</p> <p>Creating pull requests requires a personal access token with write access to your git repo. If the secret containing the token is compromised (and you could assume it as a likely scenario), it could in principle allow someone to delete your production applications.</p> <p>Please make sure you understand the <a href=#security>Security</a> section below before taking the steps to enable automated pull requests.</p> </div> <p>This section covers adding a promotion by pull request (PR) strategy, so that whenever the application defined in a pipeline is upgraded in one of the pipeline's environments, a PR is created that updates the manifest file setting the application version in the next environment.</p> <p>The dynamic nature of GitOps deployments requires you to assist Weave GitOps a little with information on which repository hosts the manifest files, how to authenticate with the repository and the Git provider API, and which file hosts the version definition for each environment.</p> <h3 id=security>Security<a class=headerlink href=#security title="Permanent link">¶</a></h3> <h4 id=environments-and-repositories>Environments and Repositories<a class=headerlink href=#environments-and-repositories title="Permanent link">¶</a></h4> <ol> <li>Use it in low-risk environments and not in production: pipelines is an alpha feature and not yet production-ready.</li> <li>Make sure you have considered possible attack vectors to production, and put controls in place. Some of these scenarios are:</li> <li>In the case of a <a href=https://fluxcd.io/flux/guides/repository-structure/#monorepo>monorepo</a>: you want to ensure that a compromised token for a test cluster cannot end up doing a promotion in production, without at least a pull request review; for example, by using <a href=https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners>Codeowners</a>.</li> <li>In the case of <a href=https://fluxcd.io/flux/guides/repository-structure/#repo-per-environment>repo per environment</a> you want to ensure that a pipeline is configured with your test environment repo URL. You also want to ensure that you have segregation of tokens per environment rather than allowing a token to access any environment repo.</li> </ol> <h4 id=rbac>RBAC<a class=headerlink href=#rbac title="Permanent link">¶</a></h4> <ol> <li> <p>Only allow creation of RBAC resources from paths where compliance controls are in place. For example, do not allow regular users to create or update RBAC resources; or, if users must create RBAC resources, restrict them by namespace.</p> </li> <li> <p>Follow the principle of "Least Privilege" RBAC as explained in <a href=https://kubernetes.io/docs/concepts/security/rbac-good-practices/ >Kubernetes RBAC Good Practices</a>, with emphasis on the following:</p> </li> </ol> <blockquote> <p>Assign permissions at the namespace level where possible. Use RoleBindings as opposed to ClusterRoleBindings to give users rights only within a specific namespace.</p> <p>Avoid providing wildcard permissions when possible, especially to all resources. As Kubernetes is an extensible system, providing wildcard access gives rights not just to all object types that currently exist in the cluster, but also to all object types which are created in the future.</p> </blockquote> <ol> <li>Prefer granting access to specific secrets, rather than granting <code>list</code> and <code>watch</code> on secrets as:</li> </ol> <blockquote> <p>It is also important to note that list and watch access also effectively allow users to read Secret contents.</p> </blockquote> <h4 id=policy>Policy<a class=headerlink href=#policy title="Permanent link">¶</a></h4> <p>By following the guidelines above, you can have a safe initial configuration. However, given there are no deny semantics in <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole>RBAC</a>, you need to guard future changes.</p> <blockquote> <p>An RBAC Role or ClusterRole contains rules that represent a set of permissions. Permissions are purely additive (there are no "deny" rules).</p> </blockquote> <p>You should ensure that attempts to break this contract are blocked and detected. You could achieve it by using Weave GitOps' <a href=../../policy/intro/ >Policy capabilities</a>. The Policy Agent acts in two complementary modes: - <a href=../../policy/intro#admission-controller>Admission Controller</a> protects from any attempt to create non-compliant RBAC resources that would end granting access to the secret. - <a href=../../policy/intro#audit>Audit</a> helps you identify already existing resources that are out of compliance. For example, roles created before policy agent was introduced as admission controller.</p> <p>Once you have enabled Policy, the <a href=../../policy/weave-policy-profile/ >Policy Library</a> gives you a set of good practices policies that will help you keep pipeline secrets secure according to the previous RBAC recommendations. Deploy them as Kustomization based on the following example:</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>In case you don't have access to the Policy Library, work with your Weaveworks Technical Account Manager (TAM) or Weaveworks Customer Reliability Engineer (CRE) to help with this step.</p> </div> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.toolkit.fluxcd.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">policy-library</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m0s</span>
<span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/weaveworks/policy-library.git</span>
<span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">policy-library-github-credentials</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.toolkit.fluxcd.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac-secrets-good-practices</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1m0s</span>
<span class=w>  </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitRepository</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">policy-library</span>
<span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./goodpractices/kubernetes/rbac/secrets</span>
<span class=w>  </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> <details class=warning open=open> <summary>Warning</summary> <p>Policies typically allow exclusions, to accommodate privileged workloads like Flux. You can manage them via <a href=https://docs.gitops.weave.works/docs/policy/policy-configuration/ >PolicyConfig</a>. For example, in order to allow Flux you could use the following <code>PolicyConfig</code>:</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pac.weave.works/v2beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PolicyConfig</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">allow-flux</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>match</span><span class=p>:</span>
<span class=w>    </span><span class=nt>apps</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
<span class=nt>config</span><span class=p>:</span>
<span class=w>    </span><span class=nt>weave.templates.rbac-prohibit-wildcards-policyrule-resources</span><span class=p>:</span>
<span class=w>    </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exclude_label_key</span><span class=p>:</span><span class=w> </span><span class=s>"app.kubernetes.io/part-of"</span>
<span class=w>        </span><span class=nt>exclude_label_value</span><span class=p>:</span><span class=w> </span><span class=s>"flux"</span>
<span class=w>    </span><span class=nt>weave.templates.rbac-prohibit-wildcards-policyrule-verbs</span><span class=p>:</span>
<span class=w>    </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exclude_label_key</span><span class=p>:</span><span class=w> </span><span class=s>"app.kubernetes.io/part-of"</span>
<span class=w>        </span><span class=nt>exclude_label_value</span><span class=p>:</span><span class=w> </span><span class=s>"flux"</span>
<span class=w>    </span><span class=nt>weave.policies.rbac-prohibit-list-secrets</span><span class=p>:</span>
<span class=w>    </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exclude_label_key</span><span class=p>:</span><span class=w> </span><span class=s>"app.kubernetes.io/part-of"</span>
<span class=w>        </span><span class=nt>exclude_label_value</span><span class=p>:</span><span class=w> </span><span class=s>"flux"</span>
<span class=w>    </span><span class=nt>weave.policies.rbac-prohibit-watch-secrets</span><span class=p>:</span>
<span class=w>    </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exclude_label_key</span><span class=p>:</span><span class=w> </span><span class=s>"app.kubernetes.io/part-of"</span>
<span class=w>        </span><span class=nt>exclude_label_value</span><span class=p>:</span><span class=w> </span><span class=s>"flux"</span>
<span class=w>    </span><span class=nt>weave.policies.rbac-prohibit-wildcard-secrets</span><span class=p>:</span>
<span class=w>    </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exclude_label_key</span><span class=p>:</span><span class=w> </span><span class=s>"app.kubernetes.io/part-of"</span>
<span class=w>        </span><span class=nt>exclude_label_value</span><span class=p>:</span><span class=w> </span><span class=s>"flux"</span>
</code></pre></div> <p>Remind not allowing users to create RBAC resources without compliance checks. Otherwise, they could create RBAC resources that could escape this runtime control.</p> </details> <p>In addition to guarding against privilege escalation via RBAC, you should guard against privilege escalation <a href=https://kubernetes.io/docs/concepts/security/rbac-good-practices/#workload-creation>through workloads</a>:</p> <blockquote> <p>Permission to create workloads (either Pods, or workload resources that manage Pods) in a namespace implicitly grants access to many other resources in that namespace, such as Secrets, ConfigMaps, and PersistentVolumes that can be mounted in Pods</p> </blockquote> <p>You could do that by creating pipeline namespaces to hold the Pipeline and its Secret, without permission to run workloads. You could enforce the latter one by using the Policy <a href=https://github.com/weaveworks/policy-library/blob/main/policies/ControllerProhibitNamespace/policy.yaml>Containers Should Not Run In Namespace</a> from the Policy Library and <a href=https://docs.gitops.weave.works/docs/policy/policy-configuration/ >PolicyConfig</a> as follows:</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Update updates when onboarding a new pipeline. Consider using Weave Gitops self-service capabilities <a href=https://docs.gitops.weave.works/docs/gitops-templates/intro/ >GitOps Templates</a> or <a href=https://docs.gitops.weave.works/docs/gitopssets/intro/ >GitOpsSets</a> to help you with the task.</p> </div> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pac.weave.works/v2beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PolicyConfig</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">reject-workloads-pipeline-namespace</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>match</span><span class=p>:</span>
<span class=w>    </span><span class=nt>namespaces</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=w>  </span><span class=nt>config</span><span class=p>:</span>
<span class=w>    </span><span class=nt>weave.policies.containers-should-not-run-in-namespace</span><span class=p>:</span>
<span class=w>      </span><span class=nt>parameters</span><span class=p>:</span>
<span class=w>        </span><span class=nt>custom_namespace</span><span class=p>:</span><span class=w> </span><span class=s>"podinfo"</span>
</code></pre></div> <h4 id=service-account>Service Account<a class=headerlink href=#service-account title="Permanent link">¶</a></h4> <p>To enable the Pipeline Controller to read the secret, we need to grant access via RBAC. The promotion credentials secret needs to be in the same namespace as the <code>Pipeline</code> resource on the management cluster. You should create a <code>RoleBinding</code> for the Pipeline Controller <code>ServiceAccount</code> in the pipeline namespace. For a pipeline in namespace <code>podinfo</code>, it would look like the following:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">read-app-promotion-credentials</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span><span class=w> </span><span class=c1># change for the pipeline namespace</span>
<span class=nt>rules</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>""</span>
<span class=w>    </span><span class=nt>resourceNames</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>"app-promotion-credentials"</span><span class=w> </span><span class=c1># change for the secret name holding the pull requests secret</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>"secrets"</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span>
<span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>"get"</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pipeline-controller-read-app-promotion-credentials</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>roleRef</span><span class=p>:</span>
<span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">read-app-promotion-credentials</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">chart-pipeline-controller</span><span class=w> </span><span class=c1># change in case pipeline controller service account has a different name in your context</span>
<span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flux-system</span>
</code></pre></div> <h4 id=verify-security-context>Verify Security Context<a class=headerlink href=#verify-security-context title="Permanent link">¶</a></h4> <p>Use <a href=https://github.com/weaveworks/weave-gitops-quickstart/tree/main/pipelines-promotions-security>pipeline promotions security</a> to verify that your environments meets the security context described earlier.</p> <p>Once deployed you could see how the different resources are being rejected. See those rejections in the Violations UI:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=../../img/pipeline-security-violations.png><img alt="privilege escalation blocked" src=../../img/pipeline-security-violations.png></a></p> <p>In addition, verify that the Pipeline controller can only get the secret by the following tests:</p> <p>List access is denied:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>secret<span class=w> </span>-n<span class=w> </span>podinfo<span class=w>  </span>--as<span class=o>=</span>system:serviceaccount:flux-system:chart-pipeline-controller

Error<span class=w> </span>from<span class=w> </span>server<span class=w> </span><span class=o>(</span>Forbidden<span class=o>)</span>:<span class=w> </span>secrets<span class=w> </span>is<span class=w> </span>forbidden:<span class=w> </span>User<span class=w> </span><span class=s2>"system:serviceaccount:flux-system:chart-pipeline-controller"</span><span class=w> </span>cannot<span class=w> </span>list<span class=w> </span>resource<span class=w> </span><span class=s2>"secrets"</span><span class=w> </span><span class=k>in</span><span class=w> </span>API<span class=w> </span>group<span class=w> </span><span class=s2>""</span><span class=w> </span><span class=k>in</span><span class=w> </span>the<span class=w> </span>namespace<span class=w> </span><span class=s2>"podinfo"</span>
</code></pre></div> <p>Get access is allowed:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>secret<span class=w> </span>-n<span class=w> </span>podinfo<span class=w>  </span>--as<span class=o>=</span>system:serviceaccount:flux-system:chart-pipeline-controller<span class=w> </span>app-promotion-credentials

NAME<span class=w>                        </span>TYPE<span class=w>     </span>DATA<span class=w>   </span>AGE
app-promotion-credentials<span class=w>   </span>Opaque<span class=w>   </span><span class=m>1</span><span class=w>      </span>21m
</code></pre></div> <h4 id=tokens>Tokens<a class=headerlink href=#tokens title="Permanent link">¶</a></h4> <ol> <li><strong>Create a user account for pull request changes</strong>: this user context would be used to do any git provider operation, and from the security and auditing perspectives, you don't want to impersonate a real user for it.</li> </ol> <details class=example> <summary>Expand to see example</summary> <p><figure> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/bot-account.png><img alt="using bot account" src=/img/bot-account.png></a> </figure></p> </details> <ol> <li><strong>Do not use long-live tokens</strong>: set an expiration date and rotate them according to your security policy.</li> </ol> <details class=example> <summary>Expand to see example</summary> <p><figure> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/create-token-with-expiration.png><img alt="create token with expiration" src=/img/create-token-with-expiration.png></a> </figure></p> </details> <ol> <li><strong>Honour the least privilege principle</strong>: avoid having high privilege tokens. Restrict the token to your just your repo and to just the operations required.</li> </ol> <details class=example> <summary>Expand to see example</summary> <p>For example, if the case of GitHub, use <a href=https://github.blog/2022-10-18-introducing-fine-grained-personal-access-tokens-for-github/ >fine-grained tokens</a> to only allow access to the single repo that your configuration manifests exist.</p> <p><figure> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/fine-grained-token.png><img alt="create least privileged token" src=/img/fine-grained-token.png></a> </figure></p> </details> <ol> <li><strong>Review the tokens on a regular basis following your git provider recommendations</strong>. Ensure that:<ul> <li>Only the ones that are required are present.</li> <li>Tokens close to their expiration date are cycled.</li> </ul> </li> </ol> <details class=example> <summary>Expand to see example</summary> <p>For example, using github and fine-grained tokens you <a href=https://github.blog/2022-10-18-introducing-fine-grained-personal-access-tokens-for-github/#approving-and-auditing-personal-access-tokens>could do so</a>.</p> <p><figure> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/manage-fine-grained.png><img alt="review tokens" src=/img/manage-fine-grained.png></a> </figure></p> </details> <ol> <li><strong>Review git provider recommendations and examples</strong></li> <li><a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token>GitHub</a></li> <li><a href=https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html>GitLab</a></li> </ol> <h3 id=add-markers-to-app-manifests>Add markers to app manifests<a class=headerlink href=#add-markers-to-app-manifests title="Permanent link">¶</a></h3> <p>The discovery of the version field is done using deterministic markers in a YAML manifest file. An example <code>HelmRelease</code> manifest with such a marker looks like this:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>      </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.13.7</span><span class=w> </span><span class=c1># {"$promotion": "pipeline-01:my-app:prod"}</span>
</code></pre></div> <p>The value of the <code>$promotion</code> field in the comment is comprised of 3 components separated by colons:</p> <ol> <li>The first field is the Namespace of the pipeline resource that the app is part of. In the example above this is <code>pipeline-01</code>.</li> <li>The second field denotes the name of the pipeline resource.</li> <li>The third field is the name of the environment that this specific HelmRelease targets. The environment name in the marker needs to match with the <code>name</code> field of one of the environments defined in the pipeline's <code>.spec.environments</code> array.</li> </ol> <p>Weave GitOps Enterprise will look for this marker whenever it receives an event from the respective HelmRelease of one of the leaf clusters and patch the file with the version denoted in the event (see the section above for instructions on setting up notification events from leaf clusters). Finally, it will create a Git provider PR to update the version of the application for the next environment in the pipeline.</p> <h3 id=supported-git-providers>Supported Git Providers<a class=headerlink href=#supported-git-providers title="Permanent link">¶</a></h3> <p>The following Git providers are currently support by this promotion strategy:</p> <ul> <li><a href=https://github.com/ >GitHub</a></li> <li><a href=https://gitlab.com/ >GitLab</a></li> <li><a href=https://www.atlassian.com/software/bitbucket/enterprise>BitBucket Server / DataCenter</a></li> </ul> <p>Select your Git provider via <code>.spec.promotion.strategy.pull-request.type</code>. For example, for <code>gitlab</code> it would look similar to:</p> <div class=highlight><pre><span></span><code><span class=nt>promotion</span><span class=p>:</span>
<span class=w>  </span><span class=nt>strategy</span><span class=p>:</span>
<span class=w>    </span><span class=nt>pull-request</span><span class=p>:</span>
<span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitlab</span>
<span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s>"https://gitlab.com/weaveworks/&lt;my-awesome-project.git&gt;"</span>
<span class=w>      </span><span class=nt>baseBranch</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class=w>      </span><span class=nt>secretRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitlab-promotion-credentials</span>
</code></pre></div> <p>More info in the <a href=../spec/v1alpha1/pipeline/#pipeline>spec</a>.</p> <h3 id=credentials-secret>Credentials Secret<a class=headerlink href=#credentials-secret title="Permanent link">¶</a></h3> <p>In the journey of creating a pull request, there are different secrets involved:</p> <ol> <li>Pipeline controller receives events via <a href=./#setup-notifications-from-leaf-clusters>webhook from leaf clusters</a>. An <a href=https://en.wikipedia.org/wiki/HMAC>HMAC</a> is used for verification so a shared key should be provided in this case.</li> <li>Pipeline controller clones and patches manifests to promote from the pipeline configuration repo. A set of <a href=https://fluxcd.io/flux/components/source/gitrepositories/#secret-reference>git credentials</a> are required.</li> <li>Pipeline controller uses git provider api to create the pull request with the promoted manifests. A Personal Access Token (PAT) needs to be created to interact with pipelines git provider API. This PAT is also used to list pull requests from the configured repository.</li> </ol> <p>Create a Kubernetes secret with the previous data.</p> <details class=example> <summary>Expand to see example</summary> <div class=highlight><pre><span></span><code><span class=c1># example to use git over https with basic auth and pat</span>
$<span class=w> </span>kubectl<span class=w> </span>create<span class=w> </span>secret<span class=w> </span>generic<span class=w> </span>promotion-credentials<span class=w> </span><span class=se>\</span>
--namespace<span class=o>=</span>pipeline-01<span class=w> </span><span class=se>\</span>
--from-literal<span class=o>=</span><span class=s2>"username=&lt;bot account name&gt;"</span><span class=w> </span><span class=se>\</span>
--from-literal<span class=o>=</span><span class=s2>"password=&lt;token value&gt;"</span><span class=w> </span><span class=se>\</span>
--from-literal<span class=o>=</span><span class=s2>"token=&lt;token value&gt;"</span><span class=w> </span><span class=se>\</span>
--from-literal<span class=o>=</span><span class=s2>"hmac-key=&lt;hmac-key value&gt;"</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-credentials</span>
<span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pipeline-01</span>
<span class=nt>data</span><span class=p>:</span>
<span class=nt>username</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ZXhhbXBsZQ==</span>
<span class=nt>password</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ZXhhbXBsZS1wYXNzd29yZA==</span>
<span class=nt>token</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Z2hwX01IL3RsTFpXTXZMY0FxVWRYY1ZGL0lGbzh0WDdHNjdsZmRxWQ==</span>
<span class=nt>hmac-key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">OEIzMTNBNjQ0REU0OEVGODgxMTJCQ0VFNTQ3NkE=</span>
<span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
</code></pre></div> </details> <div class="admonition tip"> <p class=admonition-title>Tip</p> <ul> <li>The Git provider token provided in the <code>token</code> field needs to be given permission to create pull requests in the pipeline's repository (defined in <code>.spec.promotion.strategy.pull-request.url</code>).</li> <li>The <code>hmac-key</code> field must match the key used for the Provider resource (.spec.secretRef), if specified in the leaf clusters.</li> </ul> </div> <h3 id=define-promotion-in-pipeline-resource>Define promotion in pipeline resource<a class=headerlink href=#define-promotion-in-pipeline-resource title="Permanent link">¶</a></h3> <p>The field <code>.spec.promotion.strategy.pull-request</code> defines details about the Git repository used for promoting the given app. Set the <code>secretRef.name</code> field to the name of the Secret created in the previous step and the <code>url</code> and <code>branch</code> fields to the Git repository's HTTPS URL and optionally a specific branch (if the branch is not set, it defaults to <code>main</code>). If using the <code>generic-hmac</code> Provider from leaf clusters, also set the <code>.spec.promotion.strategy.secretRef.name</code> to the name of the Secret created previously.</p> <p>More info in the <a href=../spec/v1alpha1/pipeline/#pipeline>spec</a></p> <h2 id=notification>Notification<a class=headerlink href=#notification title="Permanent link">¶</a></h2> <p>This section explains how to configure pipelines to work with external CI systems that are responsible for application promotions.</p> <p>This strategy uses the notification controller running on the management cluster, to forward any notifications received by the promotion webhook, from leaf clusters to external CI systems. This requires to <a href=https://fluxcd.io/flux/cheatsheets/bootstrap/#enable-notifications-for-third-party-controllers>patch</a> the Flux manifests of the management cluster, in order to allow objects of type <code>Pipeline</code> to be used as event sources. An example of a patch applied to enable this is shown below:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gotk-components.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gotk-sync.yaml</span>
<span class=nt>patches</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>patch</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|</span>
<span class=w>    </span><span class=no>- op: add</span>
<span class=w>      </span><span class=no>path: /spec/versions/0/schema/openAPIV3Schema/properties/spec/properties/eventSources/items/properties/kind/enum/-</span>
<span class=w>      </span><span class=no>value: Pipeline</span>
<span class=w>  </span><span class=nt>target</span><span class=p>:</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w>  </span><span class="l l-Scalar l-Scalar-Plain">alerts.notification.toolkit.fluxcd.io</span>
</code></pre></div> <p>You can now create Provider/Alert resources on the management cluster to forward notifications to external systems. For example, the Provider resource shown below is used to invoke a GitHub Actions workflow on a repository:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">notification.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Provider</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-my-app-via-github-actions</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">githubdispatch</span>
<span class=w>  </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/my-org/my-app-repo</span>
<span class=w>  </span><span class=nt>secretRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">github-credentials</span>
</code></pre></div> <p>To use this Provider, add an Alert that uses the pipeline resource defined on the management cluster as an event source. An example of such an Alert is shown below:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">notification.toolkit.fluxcd.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Alert</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-my-app-via-github-actions</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>eventSeverity</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">info</span>
<span class=w>  </span><span class=nt>eventSources</span><span class=p>:</span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pipeline</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app-ns</span>
<span class=w>  </span><span class=nt>providerRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-my-app-via-github-actions</span>
</code></pre></div> <p>The notification controller running on the management cluster is now configured to forward any promotion notifications received from leaf clusters. To actually use this strategy from a pipeline, set the promotion field as shown below:</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pipelines.weave.works/v1alpha1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pipeline</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app-ns</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=w>  </span><span class=nt>promotion</span><span class=p>:</span>
<span class=w>    </span><span class=nt>notification</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</code></pre></div> <p>Promotion notifications from leaf clusters should now be forwarded via the notification controller running on the management cluster and should include information about the version of the application being promoted.</p> <h2 id=manual-promotion>Manual promotion<a class=headerlink href=#manual-promotion title="Permanent link">¶</a></h2> <p>The supported strategies mentioned above, do not require any user interaction when handling promotions. However, there is often a need for a human operator to manually approve a promotion to the next environment. To achieve that, set the <code>spec.promotion.manual</code> key to <code>true</code>.</p> <details class=example> <summary>Expand to see example</summary> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pipelines.weave.works/v1alpha1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Pipeline</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app</span>
<span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">my-app-ns</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>promotion</span><span class=p>:</span>
<span class=w>    </span><span class=nt>manual</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>    </span><span class=nt>strategy</span><span class=p>:</span>
<span class=w>    </span><span class=nt>pull-request</span><span class=p>:</span>
<span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">github</span>
<span class=w>        </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/my-org/my-app-repo</span>
<span class=w>        </span><span class=nt>baseBranch</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
<span class=w>        </span><span class=nt>secretRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">promotion-credentials</span>
</code></pre></div> </details> <p>When this key is set and a promotion is detected, Weave GitOps will prompt the user to manually promote the application to the next environment, via the use of a button shown under the next environment.</p> <figure> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/manual-promotion-ui.png><img alt=ManualPromotionUI height=70% loading=lazy src=/img/manual-promotion-ui.png width=70%></a> </p> <figcaption>Manual promotion of an application</figcaption> </figure> <h2 id=configuration>Configuration<a class=headerlink href=#configuration title="Permanent link">¶</a></h2> <h3 id=retry-logic>Retry Logic<a class=headerlink href=#retry-logic title="Permanent link">¶</a></h3> <p>By default if a promotion fails, an exponential back-off retry happens and returns with an error only after three retries.</p> <p>Through Helm values, the retry logic is configurable.</p> <div class=highlight><pre><span></span><code><span class=c1># values.yaml</span>
<span class=nt>promotion</span><span class=p>:</span>
<span class=w>  </span><span class=nt>retry</span><span class=p>:</span>
<span class=w>    </span><span class=c1># Initial delay between retries.</span>
<span class=w>    </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class=w>    </span><span class=c1># Maximum delay between retries.</span>
<span class=w>    </span><span class=nt>maxDelay</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class=w>    </span><span class=c1># Number of attempts.</span>
<span class=w>    </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</code></pre></div> <p>The promotion happens through an HTTP endpoint call, that endpoint may has connection timeout limits, that's why the <code>maxDelay</code> option is there. If the calculated delay would exceed this value, it will use that as delay. For example if the delay values would be <code>[2, 4, 8, 16, 32, 64]</code>, but <code>maxDelay</code> is set to 15, the list will be <code>[2, 4, 8, 15, 15, 15]</code>. With this option, the promotion will be retried on failure, but the sum of delay values will be only 59 seconds instead of 126 seconds.</p> <h3 id=rate-limiting>Rate Limiting<a class=headerlink href=#rate-limiting title="Permanent link">¶</a></h3> <p>The promotion endpoint can be exposed to the internet (for example github actions), to mitigate DoS attacks, the endpoint has rate limits. By default it's 20 requests per 30 seconds.</p> <p>Rate limiting can be configured through Helm values:</p> <div class=highlight><pre><span></span><code><span class=c1># values.yaml</span>
<span class=nt>promotion</span><span class=p>:</span>
<span class=w>  </span><span class=nt>rateLimit</span><span class=p>:</span>
<span class=w>    </span><span class=c1># Number of requests allowed in set interval.</span>
<span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div> <form class=md-feedback hidden name=feedback> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" data-md-value=1 title="This page was helpful" type=submit> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M5 9v12H1V9h4m4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21H9m0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03V19Z"></path></svg> </button> <button class="md-feedback__icon md-icon" data-md-value=0 title="This page could be improved" type=submit> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 15V3h4v12h-4M15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3h9m0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97V5Z"></path></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/eksctl-io/eksctl/issues/new/?title=[Feedback]+Promoting%20applications+-+/pipelines/promoting-applications/" rel=noopener target=_blank>feedback form <a>. </a></a></div> </div> </div> </fieldset> </form> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> <a class="md-top md-icon" data-md-component=top hidden href=#> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg> Back to top </a> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: Authorization" class="md-footer__link md-footer__link--prev" href=../authorization/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Authorization </div> </div> </a> <a aria-label="Next: Using GitOpsTemplates for Pipelines" class="md-footer__link md-footer__link--next" href=../pipelines-templates/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Using GitOpsTemplates for Pipelines </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <p>Site powered by <a href=https://netlify.com>Netlify ©</a></p> <p>Copyright © 2023 Weaveworks <br> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </p> </div> <div class=md-social> <a class=md-social__link href=https://www.facebook.com/WeaveworksInc/ rel=noopener target=_blank title=www.facebook.com> <svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg> </a> <a class=md-social__link href=https://www.linkedin.com/company/weaveworks rel=noopener target=_blank title=www.linkedin.com> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </a> <a class=md-social__link href=https://twitter.com/weaveworks rel=noopener target=_blank title=twitter.com> <svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> </a> <a class=md-social__link href=https://slack.weave.works/ rel=noopener target=_blank title=slack.weave.works> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"></path></svg> </a> <a class=md-social__link href=https://www.youtube.com/c/WeaveWorksInc rel=noopener target=_blank title=www.youtube.com> <svg viewbox="0 0 576 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent hidden id=__consent> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle id=__settings type=checkbox> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input checked name=analytics type=checkbox> <span class=task-list-indicator></span> Google Analytics <label> </label></label></li> <li class=task-list-item> <label class=task-list-control> <input checked name=github type=checkbox> <span class=task-list-indicator></span> GitHub <label> </label></label></li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../..", "features": ["header.autohide", "navigation.instant", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.footer", "search.highlight", "search.share", "search.suggest", "content.code.annotate", "content.tooltips", "content.tabs.link", "content.code.copy"], "search": "../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.51d95adb.min.js></script> <script src=../../javascripts/extra.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body> </html>