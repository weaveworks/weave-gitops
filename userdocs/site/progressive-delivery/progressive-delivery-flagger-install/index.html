<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="The Flux expansion pack from the founders of Flux" name=description><meta content="Weave GitOps authors" name=author><link href=https://docs.gitops.weave.works/progressive-delivery/progressive-delivery-flagger-install/ rel=canonical><link href=../../policy/commit-time-checks/ rel=prev><link href=../flagger-manual-gating/ rel=next><link href=../../img/favicon_150px.png rel=icon><meta content="mkdocs-1.4.2, mkdocs-material-9.0.6" name=generator><title>Progressive Delivery Using Flagger - Weave GitOps</title><link href=../../assets/stylesheets/main.558e4712.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.2505c338.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Segoe+UI:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Segoe UI";--md-code-font:"Roboto Mono"}</style><link href=../../stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script><meta content=website property=og:type><meta content="Progressive Delivery Using Flagger - Weave GitOps" property=og:title><meta content="The Flux expansion pack from the founders of Flux" property=og:description><meta content=https://docs.gitops.weave.works/assets/images/social/progressive-delivery/progressive-delivery-flagger-install.png property=og:image><meta content=image/png property=og:image:type><meta content=1200 property=og:image:width><meta content=630 property=og:image:height><meta content=https://docs.gitops.weave.works/progressive-delivery/progressive-delivery-flagger-install/ property=og:url><meta content=summary_large_image name=twitter:card><meta content="Progressive Delivery Using Flagger - Weave GitOps" name=twitter:title><meta content="The Flux expansion pack from the founders of Flux" name=twitter:description><meta content=https://docs.gitops.weave.works/assets/images/social/progressive-delivery/progressive-delivery-flagger-install.png name=twitter:image><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent=light-blue data-md-color-primary=deep-orange data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#progressive-delivery-using-flagger-enterprise> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label="Weave GitOps" class="md-header__button md-logo" data-md-component=logo href=../.. title="Weave GitOps"> <img alt=logo src=../../img/logo.ico> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Weave GitOps </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Progressive Delivery Using Flagger </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent=light-blue data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary=deep-orange data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent=light-blue data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary=deep-orange data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <a aria-label=Share class="md-search__icon md-icon" data-clipboard data-clipboard-text data-md-component=search-share href=javascript:void(0) tabindex=-1 title=Share> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"></path></svg> </a> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/weaveworks/weave-gitops title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> weaveworks/weave-gitops </div> </a> </div> </nav> <nav aria-label=Tabs class=md-tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a class=md-tabs__link href=../..> Home </a> </li> <li class=md-tabs__item> <a href=../../intro-weave-gitops/ class="md-tabs__link md-tabs__link--active"> Docs </a> </li> <li class=md-tabs__item> <a href=../../references/helm-reference/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../security/ class=md-tabs__link> Security </a> </li> <li class=md-tabs__item> <a href=../../feedback-and-telemetry/ class=md-tabs__link> Feedback &amp; Telemetry </a> </li> <li class=md-tabs__item> <a href=../../help-and-support/ class=md-tabs__link> Support </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary md-nav--lifted" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label="Weave GitOps" class="md-nav__button md-logo" data-md-component=logo href=../.. title="Weave GitOps"> <img alt=logo src=../../img/logo.ico> </a> Weave GitOps </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/weaveworks/weave-gitops title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> weaveworks/weave-gitops </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label aria-expanded=true class=md-nav__link for=__nav_2 tabindex=0> Docs <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Docs class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Docs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 id=__nav_2_1 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1 tabindex=0> Introducing Weave GitOps <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Introducing Weave GitOps" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Introducing Weave GitOps </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../intro-weave-gitops/ class=md-nav__link> Introducing Weave GitOps </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_2 id=__nav_2_1_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1_2 tabindex=0> Weave GitOps OSS <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Weave GitOps OSS" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> Weave GitOps OSS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../open-source/install-oss/ class=md-nav__link> Step 1 - Install Weave GitOps Open Source </a> </li> <li class=md-nav__item> <a href=../../open-source/ui-oss/ class=md-nav__link> Step 2 - Explore the Open Source UI </a> </li> <li class=md-nav__item> <a href=../../open-source/deploy-oss/ class=md-nav__link> Step 3 - Deploy an Application </a> </li> <li class=md-nav__item> <a href=../../open-source/aws-marketplace/ class=md-nav__link> AWS Marketplace </a> </li> <li class=md-nav__item> <a href=../../open-source/run-ui-subpath/ class=md-nav__link> Optional: Running the UI on a Subpath </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_3 id=__nav_2_1_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_1_3 tabindex=0> Weave GitOps Enterprise <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Weave GitOps Enterprise" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_1_3> <span class="md-nav__icon md-icon"></span> Weave GitOps Enterprise </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../enterprise/ class=md-nav__link> Introduction to Weave GitOps Enterprise </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise/ class=md-nav__link> Install Weave GitOps Enterprise </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-cli/ class=md-nav__link> Install Weave GitOps Enterprise via CLI </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-airgap/ class=md-nav__link> Install Enterprise in Air-gapped Environments </a> </li> <li class=md-nav__item> <a href=../../enterprise/releases-enterprise/ class=md-nav__link> Enterprise Releases </a> </li> <li class=md-nav__item> <a href=../../enterprise/install-enterprise-azure/ class=md-nav__link> Azure and Weave GitOps Enterprise Installation </a> </li> <li class=md-nav__item> <a href=../../enterprise/join-cluster-azure-flux/ class=md-nav__link> Join a Cluster with Azure Flux </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../backstage/ class=md-nav__link> Backstage </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 id=__nav_2_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_3 tabindex=0> Cluster Management <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Cluster Management" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Cluster Management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cluster-management/ class=md-nav__link> Cluster Management - Introduction </a> </li> <li class=md-nav__item> <a href=../../cluster-management/managing-clusters-without-capi/ class=md-nav__link> Managing Clusters Without Cluster API </a> </li> <li class=md-nav__item> <a href=../../cluster-management/deploying-capa-eks/ class=md-nav__link> Deploying CAPA with EKS </a> </li> <li class=md-nav__item> <a href=../../cluster-management/profiles/ class=md-nav__link> Profiles </a> </li> <li class=md-nav__item> <a href=../../cluster-management/cluster-management-troubleshooting/ class=md-nav__link> Cluster Management Troubleshooting </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3_6 id=__nav_2_3_6 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_3_6 tabindex=0> Advanced Cluster management <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Advanced Cluster management" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_3_6> <span class="md-nav__icon md-icon"></span> Advanced Cluster management </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cluster-management/advanced-cluster-management-topics/how-to-inject-credentials-into-template/ class=md-nav__link> How to Inject Credentials Into Your Template </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 id=__nav_2_4 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_4 tabindex=0> Explorer <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Explorer class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Explorer </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../explorer/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../explorer/getting-started/ class=md-nav__link> Getting started </a> </li> <li class=md-nav__item> <a href=../../explorer/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../explorer/querying/ class=md-nav__link> Querying </a> </li> <li class=md-nav__item> <a href=../../explorer/operations/ class=md-nav__link> Operations </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_5 id=__nav_2_5 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_5 tabindex=0> GitOpsSets <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=GitOpsSets class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> GitOpsSets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitopssets/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-installation/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../gitopssets/templating-from-generators/ class=md-nav__link> Templating from Generators </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-api-reference/ class=md-nav__link> API reference </a> </li> <li class=md-nav__item> <a href=../../gitopssets/gitopssets-releases/ class=md-nav__link> Releases </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_6 id=__nav_2_6 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_6 tabindex=0> Guides <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Guides class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../guides/displaying-custom-metadata/ class=md-nav__link> Displaying Custom Metadata </a> </li> <li class=md-nav__item> <a href=../../guides/fluxga-upgrade/ class=md-nav__link> Upgrade to Flux GA </a> </li> <li class=md-nav__item> <a href=../../guides/anonymous-access/ class=md-nav__link> Anonymous Access </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../monitoring/ class=md-nav__link> Operations </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_8 id=__nav_2_8 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_8 tabindex=0> Pipelines <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Pipelines class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> Pipelines </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../pipelines/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../pipelines/pipelines-getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../pipelines/authorization/ class=md-nav__link> Authorization </a> </li> <li class=md-nav__item> <a href=../../pipelines/promoting-applications/ class=md-nav__link> Promoting applications </a> </li> <li class=md-nav__item> <a href=../../pipelines/pipelines-templates/ class=md-nav__link> Using GitOpsTemplates for Pipelines </a> </li> <li class=md-nav__item> <a href=../../pipelines/pipelines-with-jenkins/ class=md-nav__link> Pipelines With Jenkins Webhook </a> </li> <li class=md-nav__item> <a href=../../pipelines/pipelines-with-tekton/ class=md-nav__link> Pipelines With Tekton </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_8_8 id=__nav_2_8_8 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_8_8 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_8_8> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../pipelines/spec/v1alpha1/pipeline/ class=md-nav__link> v1alpha1 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_9 id=__nav_2_9 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_9 tabindex=0> Policy <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Policy class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> Policy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../policy/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../policy/getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../policy/authorization/ class=md-nav__link> Authorization </a> </li> <li class=md-nav__item> <a href=../../policy/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../policy/weave-policy-profile/ class=md-nav__link> Policy Profile </a> </li> <li class=md-nav__item> <a href=../../policy/policy-set/ class=md-nav__link> PolicySet </a> </li> <li class=md-nav__item> <a href=../../policy/policy-configuration/ class=md-nav__link> PolicyConfig </a> </li> <li class=md-nav__item> <a href=../../policy/releases/ class=md-nav__link> Profile Releases </a> </li> <li class=md-nav__item> <a href=../../policy/commit-time-checks/ class=md-nav__link> Commit/Build Time Checks </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_10 id=__nav_2_10 type=checkbox> <label aria-expanded=true class=md-nav__link for=__nav_2_10 tabindex=0> Progressive Delivery <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Progressive Delivery" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> Progressive Delivery </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Progressive Delivery Using Flagger <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Progressive Delivery Using Flagger </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-linkerd-using-flux> Installing Linkerd Using Flux </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-flagger-using-flux> Installing Flagger Using Flux </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#custom-resources-generated-by-flagger> Custom Resources Generated by Flagger </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-remote-cluster-permissions> Setting up Remote Cluster Permissions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#deploy-a-canary-release> Deploy a Canary Release </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#summary> Summary </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../flagger-manual-gating/ class=md-nav__link> Manual Approval for Progressive Delivery Deployments </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_11 id=__nav_2_11 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_11 tabindex=0> Secrets <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Secrets class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_11> <span class="md-nav__icon md-icon"></span> Secrets </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../secrets/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../secrets/getting-started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../../secrets/bootstrapping-secrets/ class=md-nav__link> Bootstrapping Secrets </a> </li> <li class=md-nav__item> <a href=../../secrets/setup-eso/ class=md-nav__link> Setup ESO </a> </li> <li class=md-nav__item> <a href=../../secrets/setup-sops/ class=md-nav__link> Setup SOPS </a> </li> <li class=md-nav__item> <a href=../../secrets/manage-secrets-ui/ class=md-nav__link> Manage Secrets UI </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_11_7 id=__nav_2_11_7 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_11_7 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_11_7> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../secrets/spec/v1alpha1/secretSync/ class=md-nav__link> v1alpha1 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_12 id=__nav_2_12 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_12 tabindex=0> Templates <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Templates class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_12> <span class="md-nav__icon md-icon"></span> Templates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitops-templates/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_12_2 id=__nav_2_12_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_12_2 tabindex=0> Creating Templates <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Creating Templates" class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_12_2> <span class="md-nav__icon md-icon"></span> Creating Templates </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../gitops-templates/creating-templates/ class=md-nav__link> Creating Templates </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/resource-templates/ class=md-nav__link> Resource Templates </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/repo-rendered-paths/ class=md-nav__link> Rendered Template Paths </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/profiles/ class=md-nav__link> Profiles </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/annotations/ class=md-nav__link> Annotations </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/params/ class=md-nav__link> Parameters </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/supported-langs/ class=md-nav__link> Supported Templating Languages </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/create-cluster-example/ class=md-nav__link> Example: Template to Create a CAPI Cluster </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/quickstart-templates/ class=md-nav__link> Quickstart </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../gitops-templates/cli/ class=md-nav__link> CLI </a> </li> <li class=md-nav__item> <a href=../../gitops-templates/versions/ class=md-nav__link> Version Information </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_13 id=__nav_2_13 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_13 tabindex=0> Terraform <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Terraform class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_13> <span class="md-nav__icon md-icon"></span> Terraform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../terraform/ class=md-nav__link> Introduction to Terraform Controller </a> </li> <li class=md-nav__item> <a href=../../terraform/get-started-terraform/ class=md-nav__link> Get Started </a> </li> <li class=md-nav__item> <a href=../../terraform/using-terraform-templates/ class=md-nav__link> Using Terraform Templates </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_14 id=__nav_2_14 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_2_14 tabindex=0> Workspaces <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Workspaces class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_14> <span class="md-nav__icon md-icon"></span> Workspaces </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../workspaces/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../workspaces/multi-tenancy/ class=md-nav__link> Multi Tenancy </a> </li> <li class=md-nav__item> <a href=../../workspaces/view-workspaces/ class=md-nav__link> Workspaces View </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_3 tabindex=0> Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Reference class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../references/helm-reference/ class=md-nav__link> OSS Helm Reference </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 id=__nav_3_2 type=checkbox> <label aria-expanded=false class=md-nav__link for=__nav_3_2 tabindex=0> CLI Reference <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="CLI Reference" class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> CLI Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../references/cli-reference/gitops/ class=md-nav__link> Gitops </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_check/ class=md-nav__link> Gitops check </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion/ class=md-nav__link> Gitops completion </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_bash/ class=md-nav__link> Gitops completion bash </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_fish/ class=md-nav__link> Gitops completion fish </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_powershell/ class=md-nav__link> Gitops completion powershell </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_completion_zsh/ class=md-nav__link> Gitops completion zsh </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create/ class=md-nav__link> Gitops create </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create_dashboard/ class=md-nav__link> Gitops create dashboard </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_create_terraform/ class=md-nav__link> Gitops create terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_delete/ class=md-nav__link> Gitops delete </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_delete_terraform/ class=md-nav__link> Gitops delete terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get/ class=md-nav__link> Gitops get </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get_bcrypt-hash/ class=md-nav__link> Gitops get bcrypt hash </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_get_config/ class=md-nav__link> Gitops get config </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_logs/ class=md-nav__link> Gitops logs </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_logs_terraform/ class=md-nav__link> Gitops logs terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_replan/ class=md-nav__link> Gitops replan </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_replan_terraform/ class=md-nav__link> Gitops replan terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_resume/ class=md-nav__link> Gitops resume </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_resume_terraform/ class=md-nav__link> Gitops resume terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_set/ class=md-nav__link> Gitops set </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_set_config/ class=md-nav__link> Gitops set config </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_suspend/ class=md-nav__link> Gitops suspend </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_suspend_terraform/ class=md-nav__link> Gitops suspend terraform </a> </li> <li class=md-nav__item> <a href=../../references/cli-reference/gitops_version/ class=md-nav__link> Gitops version </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../security/ class=md-nav__link> Security </a> </li> <li class=md-nav__item> <a href=../../feedback-and-telemetry/ class=md-nav__link> Feedback &amp; Telemetry </a> </li> <li class=md-nav__item> <a href=../../help-and-support/ class=md-nav__link> Support </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#prerequisites> Prerequisites </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-linkerd-using-flux> Installing Linkerd Using Flux </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#installing-flagger-using-flux> Installing Flagger Using Flux </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#custom-resources-generated-by-flagger> Custom Resources Generated by Flagger </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#setting-up-remote-cluster-permissions> Setting up Remote Cluster Permissions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#deploy-a-canary-release> Deploy a Canary Release </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#summary> Summary </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=progressive-delivery-using-flagger-enterprise>Progressive Delivery Using Flagger <sub>ENTERPRISE</sub><a class=headerlink href=#progressive-delivery-using-flagger-enterprise title="Permanent link">¶</a></h1> <p>Built upon the core tenets of continuous integration and continuous delivery (CI/CD), <a href=https://www.weave.works/blog/progressive-delivery-checklist>progressive delivery</a> involves gradually rolling out features to small groups of select users to balance performance with speed. Developers and DevOps teams use fine-grained controls to minimize the risks of pushing new features to the production environment. If the newly released feature proves to be stable and performant, it can then be released to all users.</p> <p><a href=https://docs.flagger.app/ >Flagger</a> is a progressive delivery operator for Kubernetes and part of the Flux family of open source projects. It reduces the risk of introducing new software versions and automates production releases to improve your time to delivery. Flagger implements deployment strategies—canary releases, A/B testing, Blue/Green mirroring—using a service mesh (App Mesh, Istio, Linkerd, Kuma, Open Service Mesh) or an ingress controller (Contour, Gloo, NGINX, Skipper, Traefik, APISIX) for traffic routing. For release analysis, Flagger can query Prometheus, InfluxDB, Datadog, New Relic, CloudWatch, Stackdriver, or Graphite. For alerting it uses Slack, MS Teams, Discord, and Rocket. Using Flux allows us to manage our cluster applications in a declarative way through changes in a Git repository.</p> <p>Weave GitOps Enterprise integrates with Flagger in order to provide a view on progressive delivery deployments. This includes the ability to view all the resources that Flagger manages during its operation. The default ClusterRole <code>gitops-canaries-reader</code> includes the minimum permissions necessary for a user to be able to view canary object details, metric template object details and canary related events. </p> <p>The WGE UI's Applications &gt; Delivery view provides an "at a glance" view so that you can understand the status of your progressive delivery rollouts across a fleet of connected clusters. This removes the cognitive overhead of having to know which objects to query and where they are located. You can also drill down into each rollout to understand its status and configuration, and view near-to-realtime data on any summary or details page.</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/dashboard-applications-delivery.png><img alt="Applications Delivery view" src=/img/dashboard-applications-delivery.png></a></p> <p>How to use WGE's progressive delivery offering: - if you don’t have Flagger installed on any clusters, you'll receive an onboarding message about installing it - click on the delivery tab on the menu bar to retrieve a table view of canaries with key summary information regarding their location and state - click on a canary to see more detailed information about status, gates, and other elements - click on the events tab on the detail page to see the most recent Kubernetes events for that canary and learn more about deployment history - click on the yaml tab on the detail page to see the raw yaml of the canary - view objects from any cluster/namespace that you have the appropriate permissions for, and nothing else</p> <p>Supported deployment strategies include:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/canary.svg><img alt="canary release icon" src=/img/canary.svg></a> <strong>Canary Release</strong>: the system gradually shifts traffic to a new version of an application and assesses performance—either promoting the release or abandoning it, based on performance.</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/ab.svg><img alt="a b testing icon" src=/img/ab.svg></a> <strong>A/B Testing</strong>: uses HTTP headers or cookies to ensure users remain on the same version of an application during a canary analysis.</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/blue-green.svg><img alt="blue green testing icon" src=/img/blue-green.svg></a> <strong>Blue/Green</strong>: Traffic is switched from the current application to a new version based on the success of testing.</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/mirroring.svg><img alt="blue green mirroring icon" src=/img/mirroring.svg></a> <strong>Blue/Green with Traffic Mirroring</strong>: sends copies of incoming requests to the new version of an application. The user receives the response from the current application and the other is discarded. The new version is promoted only if metrics are healthy.</p> <p>This guide uses Flux manifests to install Flagger and <a href=https://github.com/linkerd>Linkerd</a>, a <a href=https://www.cncf.io/ >CNCF</a> project and service mesh for Kubernetes and beyond. We will walk you through a full end-to-end scenario where you will: - <a href=#installing-linkerd-using-flux>Install the Linkerd service mesh</a> - <a href=#installing-flagger-using-flux>Install Flagger</a> - <a href=#deploy-a-canary-release>Deploy a sample application using a canary release strategy based on metrics provided through Linkerd's in-built Prometheus instance</a></p> <h2 id=prerequisites>Prerequisites<a class=headerlink href=#prerequisites title="Permanent link">¶</a></h2> <ul> <li>This guide assumes you already have a Kubernetes cluster running and have <a href=https://fluxcd.io/docs/get-started/ >bootstrapped Flux</a>. To apply the manifests listed here, you will need to commit them to a repository being reconciled with Flux.</li> <li>Flagger requires the <a href=https://github.com/kubernetes/api/tree/master/autoscaling/v2><code>autoscaling/v2</code></a> or <a href=https://github.com/kubernetes/api/tree/master/autoscaling/v2beta2><code>autoscaling/v2beta2</code></a> API to be installed on your cluster. You can use <code>kubectl api-resources</code> to check which API versions are supported.</li> <li>The <a href=https://smallstep.com/cli/ >step</a> CLI installed to generate certificates that support mTLS connections.</li> </ul> <h2 id=installing-linkerd-using-flux>Installing Linkerd Using Flux<a class=headerlink href=#installing-linkerd-using-flux title="Permanent link">¶</a></h2> <p>To install Linkerd we'll use a Kustomization file. It will allow us to specify the order and default namespace for the installed resources, and to generate Secrets from certificate files via the use of a <code>secretGenerator</code>.</p> <p>To support mTLS connections between meshed pods, Linkerd requires a trust anchor certificate and an issuer certificate with its corresponding key. These certificates are automatically created via the <code>linkerd install</code> command. However, when using a Helm chart to install Linkerd, you must provide these certificates deliberately. The <code>step</code> CLI, listed above, allows us to generate these certificates.</p> <p>To generate the trust anchor certificate, run: <div class=highlight><pre><span></span><code>step<span class=w> </span>certificate<span class=w> </span>create<span class=w> </span>root.linkerd.cluster.local<span class=w> </span>ca.crt<span class=w> </span>ca.key<span class=w> </span><span class=se>\</span>
--profile<span class=w> </span>root-ca<span class=w> </span>--no-password<span class=w> </span>--insecure
</code></pre></div></p> <p>To generate the issuer certificate, run: <div class=highlight><pre><span></span><code>step<span class=w> </span>certificate<span class=w> </span>create<span class=w> </span>identity.linkerd.cluster.local<span class=w> </span>issuer.crt<span class=w> </span>issuer.key<span class=w> </span><span class=se>\</span>
--profile<span class=w> </span>intermediate-ca<span class=w> </span>--not-after<span class=w> </span>8760h<span class=w> </span>--no-password<span class=w> </span>--insecure<span class=w> </span><span class=se>\</span>
--ca<span class=w> </span>ca.crt<span class=w> </span>--ca-key<span class=w> </span>ca.key
</code></pre></div></p> <p>Add the <code>ca.crt</code>, <code>issuer.crt</code>, and <code>issuer.key</code> files to the cluster repository under a <code>linkerd</code> directory.</p> <p>Let's add the three manifests for Linkerd components under the <code>./linkerd</code> directory: - A <code>Namespace</code> resource to control where the components are installed - A <code>HelmRepository</code> resource to make the Linkerd Helm repo available on the cluster - A <code>HelmRelease</code> resource to install the latest version of Linkerd from the <code>HelmRepository</code></p> <details class=example> <summary>Expand to see and copy-paste the three Linkerd manifests to add</summary> <div class=highlight><span class=filename>linkerd/namespace.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>labels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>config.linkerd.io/admission-webhooks</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">disabled</span>
</code></pre></div> <div class=highlight><span class=filename>linkerd/source.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.toolkit.fluxcd.io/v1beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://helm.linkerd.io/stable</span>
</code></pre></div> <p>Note: The value for the <code>spec.values.identity.issuer.crtExpiry</code> field below depends on the parameter value used during the creation of the issuer certificate. In this example, it should be set to one year from the certificate creation.</p> <div class=highlight><span class=filename>linkerd/releases.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>    </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd2</span>
<span class=w>    </span><span class=nt>reconcileStrategy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ChartVersion</span>
<span class=w>    </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>install</span><span class=p>:</span>
<span class=w>    </span><span class=nt>crds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Create</span>
<span class=nt>upgrade</span><span class=p>:</span>
<span class=w>    </span><span class=nt>crds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CreateReplace</span>
<span class=nt>valuesFrom</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-certs</span>
<span class=w>    </span><span class=nt>valuesKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class=w>    </span><span class=nt>targetPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">identityTrustAnchorsPEM</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-certs</span>
<span class=w>    </span><span class=nt>valuesKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">issuer.crt</span>
<span class=w>    </span><span class=nt>targetPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">identity.issuer.tls.crtPEM</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-certs</span>
<span class=w>    </span><span class=nt>valuesKey</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">issuer.key</span>
<span class=w>    </span><span class=nt>targetPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">identity.issuer.tls.keyPEM</span>
<span class=nt>values</span><span class=p>:</span>
<span class=w>    </span><span class=nt>installNamespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class=w>    </span><span class=nt>identity</span><span class=p>:</span>
<span class=w>    </span><span class=nt>issuer</span><span class=p>:</span>
<span class=w>        </span><span class=nt>crtExpiry</span><span class=p>:</span><span class=w> </span><span class=s>"2023-07-18T20:00:00Z"</span><span class=w> </span><span class=c1># Change this to match generated certificate expiry date</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-viz</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class=nt>dependsOn</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>    </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-viz</span>
<span class=w>    </span><span class=nt>reconcileStrategy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ChartVersion</span>
<span class=w>    </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
</code></pre></div> </details> <p>Next, add the following manifests. The first file instructs Kustomize to patch any <code>Secrets</code> that are referenced in <code>HelmRelease</code> manifests. The second file is a <code>Kustomization</code> that references all the other <code>linkerd</code> resource files.</p> <details class=example> <summary>Expand to see the Linkerd Kustomization manifests</summary> <div class=highlight><span class=filename>linkerd/kustomizeconfig.yaml</span><pre><span></span><code><span class=nt>nameReference</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">fieldSpecs</span><span class="p p-Indicator">:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">spec/valuesFrom/name</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
</code></pre></div> <div class=highlight><span class=filename>linkerd/kustomization.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nt>configurations</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomizeconfig.yaml</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">namespace.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">releases.yaml</span>
<span class=nt>secretGenerator</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd-certs</span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">files</span><span class="p p-Indicator">:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">issuer.crt</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">issuer.key</span>
</code></pre></div> <p>Note: The <code>secretGenerator</code> generates Secrets from the files you've just created.</p> </details> <p>At this point the <code>linkerd</code> directory in your cluster repository should look like this:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>tree<span class=w> </span>linkerd
linkerd
├──<span class=w> </span>ca.crt
├──<span class=w> </span>issuer.crt
├──<span class=w> </span>issuer.key
├──<span class=w> </span>kustomization.yaml
├──<span class=w> </span>kustomizeconfig.yaml
├──<span class=w> </span>namespace.yaml
├──<span class=w> </span>releases.yaml
└──<span class=w> </span>source.yaml
</code></pre></div> <p>Once Flux reconciles this directory to the cluster, Linkerd should be installed.</p> <p>Before proceeding to the next step, check that all the Linkerd pods have started successfully:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>linkerd<span class=w> </span>
NAME<span class=w>                                      </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
linkerd-destination-66d5668b-4mw49<span class=w>        </span><span class=m>4</span>/4<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
linkerd-identity-6b4658c74b-6nc97<span class=w>         </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
linkerd-proxy-injector-6b76789cb4-8vqj4<span class=w>   </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m

&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>linkerd-viz<span class=w> </span>
NAME<span class=w>                            </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
grafana-db56d7cb4-xlnn4<span class=w>         </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
metrics-api-595c7b564-724ps<span class=w>     </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
prometheus-5d4dffff55-8fscd<span class=w>     </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
tap-6dcb89d487-5ns8n<span class=w>            </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
tap-injector-54895654bb-9xn7k<span class=w>   </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
web-6b6f65dbc7-wltdg<span class=w>            </span><span class=m>2</span>/2<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>10m
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Any new directories that you add to the cluster repository while following this guide must be included in a path that Flux reconciles.</p> </div> <h2 id=installing-flagger-using-flux>Installing Flagger Using Flux<a class=headerlink href=#installing-flagger-using-flux title="Permanent link">¶</a></h2> <p>To install Flagger, you'll use a Kustomization file that will define the installation order and provide a default namespace for the installed resources.</p> <p>Create a new <code>flagger</code> directory. Make sure to locate it under a repository path that Flux reconciles. </p> <p>Now add under this directory the three resource manifests for Flagger: - A <code>Namespace</code> resource to control where the components are installed - A <code>HelmRepository</code> resource to make the Flagger Helm repo available on the cluster - A <code>HelmRelease</code> resource to install the latest version of Flagger and the load tester app (which generates synthetic traffic during the analysis phase), from that <code>HelmRepository</code></p> <details class=example> <summary>Expand to see the three Flagger resource manifests</summary> <div class=highlight><span class=filename>flagger/namespace.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
</code></pre></div> <div class=highlight><span class=filename>flagger/source.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.toolkit.fluxcd.io/v1beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class=nt>url</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://flagger.app</span>
</code></pre></div> <div class=highlight><span class=filename>flagger/releases.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>releaseName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=nt>install</span><span class=p>:</span>
<span class=w>    </span><span class=nt>crds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Create</span>
<span class=nt>upgrade</span><span class=p>:</span>
<span class=w>    </span><span class=nt>crds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CreateReplace</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>    </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=w>    </span><span class=nt>reconcileStrategy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ChartVersion</span>
<span class=w>    </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=nt>values</span><span class=p>:</span>
<span class=w>    </span><span class=nt>metricsServer</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://prometheus.linkerd-viz:9090</span>
<span class=w>    </span><span class=nt>meshProvider</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">linkerd</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">helm.toolkit.fluxcd.io/v2beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRelease</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">loadtester</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class=nt>chart</span><span class=p>:</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>    </span><span class=nt>chart</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">loadtester</span>
<span class=w>    </span><span class=nt>reconcileStrategy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ChartVersion</span>
<span class=w>    </span><span class=nt>sourceRef</span><span class=p>:</span>
<span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HelmRepository</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
</code></pre></div> </details> <p>Now add the following Kustomization file. It references all of the previous files that you've added:</p> <details class=example> <summary>Expand to see the Flagger Kustomization manifest</summary> <div class=highlight><span class=filename>flagger/kustomization.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">namespace.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">source.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">releases.yaml</span>
</code></pre></div> </details> <p>The <code>flagger</code> directory in the cluster repository should look like this:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>tree<span class=w> </span>flagger
flagger
├──<span class=w> </span>kustomization.yaml
├──<span class=w> </span>namespace.yaml
├──<span class=w> </span>releases.yaml
└──<span class=w> </span>source.yaml
</code></pre></div> <p>Once Flux reconciles this directory to the cluster, Flagger and the load tester app should be installed.</p> <p>Before proceeding to the next step, check that all of your Flagger pods have started successfully:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>-n<span class=w> </span>flagger
NAME<span class=w>                          </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
flagger-7d456d4fc7-knf2g<span class=w>      </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m
loadtester-855b4d77f6-scl6r<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>4m
</code></pre></div> <h2 id=custom-resources-generated-by-flagger>Custom Resources Generated by Flagger<a class=headerlink href=#custom-resources-generated-by-flagger title="Permanent link">¶</a></h2> <p>When Flagger is configured to integrate with a service mesh such as Linkerd or Istio for the rollout, this ClusterRole needs to be extended so that it can read the additional service mesh resources that Flagger generates. To display service mesh- or ingress-related resources, we require <code>spec.provider</code> to be set in each canary resource. </p> <p>The following table provides a list of all the custom resources that Flagger generates grouped by provider:</p> <table> <thead> <tr> <th>Provider</th> <th>API Group</th> <th>Resource</th> </tr> </thead> <tbody> <tr> <td>AppMesh</td> <td>appmesh.k8s.aws</td> <td>virtualnode</td> </tr> <tr> <td></td> <td>appmesh.k8s.aws</td> <td>virtualrouter</td> </tr> <tr> <td></td> <td>appmesh.k8s.aws</td> <td>virtualservice</td> </tr> <tr> <td>Linkerd</td> <td>split.smi-spec.io</td> <td>trafficsplit</td> </tr> <tr> <td>Istio</td> <td>networking.istio.io</td> <td>destinationrule</td> </tr> <tr> <td></td> <td>networking.istio.io</td> <td>virtualservice</td> </tr> <tr> <td>Contour</td> <td>projectcontour.io</td> <td>httpproxy</td> </tr> <tr> <td>Gloo</td> <td>gateway.solo.io</td> <td>routetable</td> </tr> <tr> <td></td> <td>gloo.solo.io</td> <td>upstream</td> </tr> <tr> <td>Nginx</td> <td>networking.k8s.io</td> <td>ingress</td> </tr> <tr> <td>Skipper</td> <td>networking.k8s.io</td> <td>ingress</td> </tr> <tr> <td>Traefik</td> <td>traefik.containo.us</td> <td>traefikservice</td> </tr> <tr> <td>Open Service Mesh</td> <td>split.smi-spec.io</td> <td>trafficsplit</td> </tr> <tr> <td>Kuma</td> <td>kuma.io</td> <td>trafficroute</td> </tr> <tr> <td>GatewayAPI</td> <td>gateway.networking.k8s.io</td> <td>httproute</td> </tr> </tbody> </table> <p>For example, the following manifest shows how <code>gitops-canaries-reader</code> has been extended to allow the user for viewing TrafficSplit resources when Linkerd is used:</p> <details class=example> <summary>Expand to see example canary reader RBAC</summary> <div class=highlight><span class=filename>gitops-canaries-reader.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">gitops-canaries-reader</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger.app</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">canaries</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">metrictemplates</span>
<span class=nt>verbs</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=s>""</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">events</span>
<span class=nt>verbs</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">watch</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
<span class=c1># Additional permissions for Linkerd resources are added below</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">split.smi-spec.io</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">trafficsplits</span>
<span class=nt>verbs</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
</code></pre></div> </details> <h2 id=setting-up-remote-cluster-permissions>Setting up Remote Cluster Permissions<a class=headerlink href=#setting-up-remote-cluster-permissions title="Permanent link">¶</a></h2> <p>In order to view canaries in a remote cluster from the management cluster, you need to consider the following: - The service account used to access the remote cluster needs to be able to list namespaces and custom resource definitions in the given cluster. It additionally needs to be able to impersonate users and groups. - The user or group that logs in to the management cluster, needs appropriate permissions to certain resources of the remote cluster.</p> <p>For example, applying the following manifest on remote clusters, ensures that the <code>wego-admin</code> user will be able to view canary information from within the Weave GitOps Enterprise UI on the management cluster:</p> <details class=example> <summary>Expand to see example of remote cluster canary reader</summary> <div class=highlight><span class=filename>remote-cluster-service-user-rbac.yaml</span><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">user-groups-impersonator</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>""</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"users"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"groups"</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"impersonate"</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>""</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"namespaces"</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"apiextensions.k8s.io"</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"customresourcedefinitions"</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class="p p-Indicator">]</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">impersonate-user-groups</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class=w>    </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">remote-cluster-01</span><span class=w>  </span><span class=c1># Service account created in remote cluster</span>
<span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class=nt>roleRef</span><span class=p>:</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">user-groups-impersonator</span>
<span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">canary-reader</span>
<span class=nt>rules</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>""</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"events"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"services"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"watch"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"apps"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"*"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"autoscaling"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"*"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"flagger.app"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"canaries"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"metrictemplates"</span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"watch"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"helm.toolkit.fluxcd.io"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"helmreleases"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"kustomize.toolkit.fluxcd.io"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"kustomizations"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"source.toolkit.fluxcd.io"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"buckets"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"helmcharts"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"gitrepositories"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"helmrepositories"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"ocirepositories"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=w> </span><span class=s>"get"</span><span class="p p-Indicator">,</span><span class=w> </span><span class=s>"list"</span><span class=w> </span><span class="p p-Indicator">]</span>
<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">read-canaries</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">wego-admin</span><span class=w>    </span><span class=c1># User logged in management cluster, impersonated via service account</span>
<span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class=nt>roleRef</span><span class=p>:</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">canary-reader</span>
<span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</code></pre></div> </details> <p>You may need to add more users/groups to the <code>read-canaries</code> ClusterRoleBinding to ensure additional users can view canary information from within the Weave GitOps Enterprise UI.</p> <h2 id=deploy-a-canary-release>Deploy a Canary Release<a class=headerlink href=#deploy-a-canary-release title="Permanent link">¶</a></h2> <p>To demonstrate the progressive rollout of an application, we'll use a tiny sample web app called <a href=https://github.com/stefanprodan/podinfo>podinfo</a> and configure a <a href=https://docs.flagger.app/usage/deployment-strategies#canary-release>canary release strategy</a>. </p> <p>In our example, Flagger will scale up a new version of podinfo (the canary) alongside the existing version (the primary). It will gradually increase traffic to the new version in increments of 5%, up to a maximum of 50%. Flagger will continuously monitor the new version for an acceptable request response rate and average request duration. Based on this analysis, Flagger will either update the primary to the new version or abandon the promotion, then scale the canary back down to zero.</p> <p>Create a new <code>test</code> directory and add these three canary resource manifests under it: - A <code>Namespace</code> resource to control where the components are installed - A <code>Deployment</code> and <code>HorizontalPodAutoscaler</code> for the <code>podinfo</code> application - A <code>Canary</code> resource which references the <code>Deployment</code> and <code>HorizontalPodAutoscaler</code> resources</p> <p>We don't need to define a service resource. This is specified within the canary definition and created by Flagger.</p> <details class=example> <summary>Expand to see the three canary resource manifests</summary> <div class=highlight><span class=filename>test/namespace.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class=nt>annotations</span><span class=p>:</span>
<span class=w>    </span><span class=nt>linkerd.io/inject</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">enabled</span>
</code></pre></div> <div class=highlight><span class=filename>test/deployment.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>labels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>minReadySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=nt>progressDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class=nt>strategy</span><span class=p>:</span>
<span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span>
<span class=w>    </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
<span class=nt>selector</span><span class=p>:</span>
<span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>template</span><span class=p>:</span>
<span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
<span class=w>    </span><span class=nt>annotations</span><span class=p>:</span>
<span class=w>        </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s>"true"</span>
<span class=w>        </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s>"9797"</span>
<span class=w>    </span><span class=nt>labels</span><span class=p>:</span>
<span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
<span class=w>    </span><span class=nt>containers</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfod</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/stefanprodan/podinfo:6.1.8</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">imagePullPolicy</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class=w>        </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9898</span>
<span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http-metrics</span>
<span class=w>        </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9797</span>
<span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">grpc</span>
<span class=w>        </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9999</span>
<span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class=w>        </span><span class=nt>command</span><span class=p>:</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./podinfo</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--port=9898</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--port-metrics=9797</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--grpc-port=9999</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--grpc-service-name=podinfo</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--level=info</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--random-delay=false</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">--random-error=false</span>
<span class=w>        </span><span class=nt>env</span><span class=p>:</span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PODINFO_UI_COLOR</span>
<span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s>"#34577c"</span>
<span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exec</span><span class=p>:</span>
<span class=w>            </span><span class=nt>command</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podcli</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">check</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localhost:9898/healthz</span>
<span class=w>        </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>        </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span>
<span class=w>        </span><span class=nt>exec</span><span class=p>:</span>
<span class=w>            </span><span class=nt>command</span><span class=p>:</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podcli</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">check</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">localhost:9898/readyz</span>
<span class=w>        </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>        </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>        </span><span class=nt>resources</span><span class=p>:</span>
<span class=w>        </span><span class=nt>limits</span><span class=p>:</span>
<span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2000m</span>
<span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">512Mi</span>
<span class=w>        </span><span class=nt>requests</span><span class=p>:</span>
<span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">100m</span>
<span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">64Mi</span>

<span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">autoscaling/v2beta2</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=nt>scaleTargetRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class=nt>metrics</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Resource</span>
<span class=w>    </span><span class=nt>resource</span><span class=p>:</span>
<span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cpu</span>
<span class=w>        </span><span class=nt>target</span><span class=p>:</span>
<span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Utilization</span>
<span class=w>        </span><span class=c1># scale up if usage is above</span>
<span class=w>        </span><span class=c1># 99% of the requested CPU (100m)</span>
<span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">99</span>
</code></pre></div> <div class=highlight><span class=filename>test/canary.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flagger.app/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Canary</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=nt>spec</span><span class=p>:</span>
<span class=c1># deployment reference</span>
<span class=nt>targetRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=c1># HPA reference (optional)</span>
<span class=nt>autoscalerRef</span><span class=p>:</span>
<span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">autoscaling/v2beta2</span>
<span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">podinfo</span>
<span class=c1># the maximum time in seconds for the canary deployment</span>
<span class=c1># to make progress before it is rollback (default 600s)</span>
<span class=nt>progressDeadlineSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class=nt>service</span><span class=p>:</span>
<span class=w>    </span><span class=c1># ClusterIP port number</span>
<span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9898</span>
<span class=w>    </span><span class=c1># container port number or name (optional)</span>
<span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9898</span>
<span class=nt>analysis</span><span class=p>:</span>
<span class=w>    </span><span class=c1># schedule interval (default 60s)</span>
<span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class=w>    </span><span class=c1># max number of failed metric checks before rollback</span>
<span class=w>    </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>    </span><span class=c1># max traffic percentage routed to canary</span>
<span class=w>    </span><span class=c1># percentage (0-100)</span>
<span class=w>    </span><span class=nt>maxWeight</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class=w>    </span><span class=c1># canary increment step</span>
<span class=w>    </span><span class=c1># percentage (0-100)</span>
<span class=w>    </span><span class=nt>stepWeight</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>    </span><span class=c1># Linkerd Prometheus checks</span>
<span class=w>    </span><span class=nt>metrics</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">request-success-rate</span>
<span class=w>    </span><span class=c1># minimum req success rate (non 5xx responses)</span>
<span class=w>    </span><span class=c1># percentage (0-100)</span>
<span class=w>    </span><span class=nt>thresholdRange</span><span class=p>:</span>
<span class=w>        </span><span class=nt>min</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">99</span>
<span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1m</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">request-duration</span>
<span class=w>    </span><span class=c1># maximum req duration P99</span>
<span class=w>    </span><span class=c1># milliseconds</span>
<span class=w>    </span><span class=nt>thresholdRange</span><span class=p>:</span>
<span class=w>        </span><span class=nt>max</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">500</span>
<span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class=w>    </span><span class=c1># testing (optional)</span>
<span class=w>    </span><span class=nt>webhooks</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">acceptance-test</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">pre-rollout</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://loadtester.flagger/</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
<span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">bash</span>
<span class=w>        </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=s>"curl</span><span class=nv> </span><span class=s>-sd</span><span class=nv> </span><span class=s>'test'</span><span class=nv> </span><span class=s>http://podinfo-canary.test:9898/token</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>grep</span><span class=nv> </span><span class=s>token"</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">load-test</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rollout</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">http://loadtester.flagger/</span>
<span class=w>        </span><span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
<span class=w>        </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=s>"hey</span><span class=nv> </span><span class=s>-z</span><span class=nv> </span><span class=s>2m</span><span class=nv> </span><span class=s>-q</span><span class=nv> </span><span class=s>10</span><span class=nv> </span><span class=s>-c</span><span class=nv> </span><span class=s>2</span><span class=nv> </span><span class=s>http://podinfo-canary.test:9898/"</span>
</code></pre></div> </details> <p>Add a Kustomization file to apply all resources to the <code>test</code> namespace:</p> <details class=example> <summary>Expand to see the Canary Kustomization manifest</summary> <div class=highlight><span class=filename>test/kustomization.yaml</span><pre><span></span><code><span class=nn>---</span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Kustomization</span>
<span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<span class=nt>resources</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">namespace.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">deployment.yaml</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">canary.yaml</span>
</code></pre></div> </details> <p>At this point, the <code>test</code> directory in the cluster repository should look like this:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>tree<span class=w> </span><span class=nb>test</span>
<span class=nb>test</span>
├──<span class=w> </span>canary.yaml
├──<span class=w> </span>deployment.yaml
├──<span class=w> </span>kustomization.yaml
└──<span class=w> </span>namespace.yaml
</code></pre></div> <p>After a short time, the status of the canary object should be set to <code>Initialized</code>:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/pd-details-initialized.png><img alt="Canary rollout initialized" src=/img/pd-details-initialized.png></a></p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>canary<span class=w> </span>podinfo<span class=w> </span>-n<span class=w> </span><span class=nb>test</span>
NAME<span class=w>      </span>STATUS<span class=w>        </span>WEIGHT<span class=w>   </span>LASTTRANSITIONTIME
podinfo<span class=w>   </span>Initialized<span class=w>   </span><span class=m>0</span><span class=w>        </span><span class=m>2022</span>-07-22T12:37:58Z
</code></pre></div> <p>Trigger a new rollout by bumping the version of <code>podinfo</code>:</p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span><span class=nb>set</span><span class=w> </span>image<span class=w> </span>deployment/podinfo<span class=w> </span><span class=nv>podinfod</span><span class=o>=</span>ghcr.io/stefanprodan/podinfo:6.0.1<span class=w> </span>-n<span class=w> </span><span class=nb>test</span>
</code></pre></div> <p>During the progressive rollout, the canary object reports on its current status:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/pd-details-progressing.png><img alt="Canary rollout progressing" src=/img/pd-details-progressing.png></a></p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>canary<span class=w> </span>podinfo<span class=w> </span>-n<span class=w> </span><span class=nb>test</span>
NAME<span class=w>      </span>STATUS<span class=w>        </span>WEIGHT<span class=w>   </span>LASTTRANSITIONTIME
podinfo<span class=w>   </span>Progressing<span class=w>   </span><span class=m>5</span><span class=w>       </span><span class=m>2022</span>-07-22T12:41:57Z
</code></pre></div> <p>After a short time the rollout is completed and the status of the canary object is set to <code>Succeeded</code>:</p> <p><a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/img/pd-details-succeeded.png><img alt="Canary rollout succeeded" src=/img/pd-details-succeeded.png></a></p> <div class=highlight><pre><span></span><code>&gt;<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>canary<span class=w> </span>podinfo<span class=w> </span>-n<span class=w> </span><span class=nb>test</span>
NAME<span class=w>      </span>STATUS<span class=w>      </span>WEIGHT<span class=w>   </span>LASTTRANSITIONTIME
podinfo<span class=w>   </span>Succeeded<span class=w>   </span><span class=m>0</span><span class=w>        </span><span class=m>2022</span>-07-22T12:47:58Z
</code></pre></div> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">¶</a></h2> <p>Congratulations, you have now completed a progressive delivery rollout with Flagger and Linkerd! <img alt=🎉 class=twemoji src=https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/1f389.svg title=:tada:></p> <p>Next steps: - Explore more of what <a href=https://flagger.app/ >Flagger</a> offers - Configure <a href=../flagger-manual-gating/ >manual approvals</a> for progressive delivery deployments</p> <form class=md-feedback hidden name=feedback> <fieldset> <legend class=md-feedback__title> Was this page helpful? </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" data-md-value=1 title="This page was helpful" type=submit> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M5 9v12H1V9h4m4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21H9m0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03V19Z"></path></svg> </button> <button class="md-feedback__icon md-icon" data-md-value=0 title="This page could be improved" type=submit> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 15V3h4v12h-4M15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3h9m0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97V5Z"></path></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> Thanks for your feedback! </div> <div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/eksctl-io/eksctl/issues/new/?title=[Feedback]+Progressive%20Delivery%20Using%20Flagger+-+/progressive-delivery/progressive-delivery-flagger-install/" rel=noopener target=_blank>feedback form <a>. </a></a></div> </div> </div> </fieldset> </form> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> <a class="md-top md-icon" data-md-component=top hidden href=#> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg> Back to top </a> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: Commit/Build Time Checks" class="md-footer__link md-footer__link--prev" href=../../policy/commit-time-checks/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Commit/Build Time Checks </div> </div> </a> <a aria-label="Next: Manual Approval for Progressive Delivery Deployments" class="md-footer__link md-footer__link--next" href=../flagger-manual-gating/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Manual Approval for Progressive Delivery Deployments </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <p>Site powered by <a href=https://netlify.com>Netlify ©</a></p> <p>Copyright © 2023 Weaveworks <br> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a> </p> </div> <div class=md-social> <a class=md-social__link href=https://www.facebook.com/WeaveworksInc/ rel=noopener target=_blank title=www.facebook.com> <svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg> </a> <a class=md-social__link href=https://www.linkedin.com/company/weaveworks rel=noopener target=_blank title=www.linkedin.com> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg> </a> <a class=md-social__link href=https://twitter.com/weaveworks rel=noopener target=_blank title=twitter.com> <svg viewbox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> </a> <a class=md-social__link href=https://slack.weave.works/ rel=noopener target=_blank title=slack.weave.works> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"></path></svg> </a> <a class=md-social__link href=https://www.youtube.com/c/WeaveWorksInc rel=noopener target=_blank title=www.youtube.com> <svg viewbox="0 0 576 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent hidden id=__consent> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle id=__settings type=checkbox> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input checked name=analytics type=checkbox> <span class=task-list-indicator></span> Google Analytics <label> </label></label></li> <li class=task-list-item> <label class=task-list-control> <input checked name=github type=checkbox> <span class=task-list-indicator></span> GitHub <label> </label></label></li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script> <script id=__config type=application/json>{"base": "../..", "features": ["header.autohide", "navigation.instant", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.footer", "search.highlight", "search.share", "search.suggest", "content.code.annotate", "content.tooltips", "content.tabs.link", "content.code.copy"], "search": "../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.51d95adb.min.js></script> <script src=../../javascripts/extra.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body> </html>